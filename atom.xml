<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://DragonFive.github.io/</id>
    <title>dragon</title>
    <updated>2019-11-13T13:52:50.152Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://DragonFive.github.io/"/>
    <link rel="self" href="https://DragonFive.github.io//atom.xml"/>
    <subtitle>Code is cheap, show me the theory</subtitle>
    <logo>https://DragonFive.github.io//images/avatar.png</logo>
    <icon>https://DragonFive.github.io//favicon.ico</icon>
    <rights>All rights reserved 2019, dragon</rights>
    <entry>
        <title type="html"><![CDATA[caffe-æºç å­¦ä¹ â€”â€”åªçœ‹ä¸€ç¯‡å°±å¤Ÿäº†]]></title>
        <id>https://DragonFive.github.io//post/caffe-source-code-stud</id>
        <link href="https://DragonFive.github.io//post/caffe-source-code-stud">
        </link>
        <updated>2017-06-12T13:18:22.000Z</updated>
        <summary type="html"><![CDATA[<hr>
<p>title: caffe-æºç å­¦ä¹ â€”â€”åªçœ‹ä¸€ç¯‡å°±å¤Ÿäº†<br>
date: 2017/6/12 15:04:12</p>
<p>categories:</p>
<ul>
<li>æ·±åº¦å­¦ä¹ <br>
tags:</li>
<li>æ·±åº¦å­¦ä¹ </li>
<li>caffe</li>
<li>deeplearning</li>
<li>python</li>
</ul>
<hr>
<h1 id="ç½‘ç»œæ¨¡å‹">ç½‘ç»œæ¨¡å‹</h1>
<p>è¯´caffeä»£ç éš¾æ‡‚ï¼Œå…¶å®å…³é”®ç‚¹åœ¨äºcaffeä¸­æœ‰å¾ˆå¤šåŸºç¡€çš„æ•°å­¦è¿ç®—ä»£ç ï¼Œå¦‚æœèƒ½å¤Ÿå¯¹æŒæ¡è¿™äº›æ•°å­¦è¿ç®—ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ¨å…¬å¼äº†ã€‚</p>
<h2 id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h2>
<h2 id="sigmoid">sigmoid</h2>
<p>çœ‹softmaxå‡½æ•°ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ç®€å•çš„sigmoid, è¿™ä¸ªsigmoid layerçš„cppå®ç°æ˜¯éå¸¸ç®€æ´çš„ã€‚ sigmoidçš„cppæ–‡ä»¶é‡Œä¸»è¦ç»™äº†ä¸‰ä¸ªå‡½æ•°çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯sigmoidå‡½æ•°ï¼Œforward_cpu, backward_cpu,åœ¨cppæ–‡ä»¶é‡Œåªå®ç°äº†ç®—æ³•çš„CPUç‰ˆæœ¬ï¼Œè‡³äºGPUç‰ˆæœ¬çš„å‡½æ•°å®ç°æ”¾åœ¨.cuæ–‡ä»¶é‡Œé¢ã€‚</p>
]]></summary>
        <content type="html"><![CDATA[<hr>
<p>title: caffe-æºç å­¦ä¹ â€”â€”åªçœ‹ä¸€ç¯‡å°±å¤Ÿäº†<br>
date: 2017/6/12 15:04:12</p>
<p>categories:</p>
<ul>
<li>æ·±åº¦å­¦ä¹ <br>
tags:</li>
<li>æ·±åº¦å­¦ä¹ </li>
<li>caffe</li>
<li>deeplearning</li>
<li>python</li>
</ul>
<hr>
<h1 id="ç½‘ç»œæ¨¡å‹">ç½‘ç»œæ¨¡å‹</h1>
<p>è¯´caffeä»£ç éš¾æ‡‚ï¼Œå…¶å®å…³é”®ç‚¹åœ¨äºcaffeä¸­æœ‰å¾ˆå¤šåŸºç¡€çš„æ•°å­¦è¿ç®—ä»£ç ï¼Œå¦‚æœèƒ½å¤Ÿå¯¹æŒæ¡è¿™äº›æ•°å­¦è¿ç®—ï¼Œå‰©ä¸‹çš„å°±æ˜¯æ¨å…¬å¼äº†ã€‚</p>
<h2 id="æ¿€æ´»å‡½æ•°">æ¿€æ´»å‡½æ•°</h2>
<h2 id="sigmoid">sigmoid</h2>
<p>çœ‹softmaxå‡½æ•°ä¹‹å‰å…ˆçœ‹ä¸€ä¸‹ç®€å•çš„sigmoid, è¿™ä¸ªsigmoid layerçš„cppå®ç°æ˜¯éå¸¸ç®€æ´çš„ã€‚ sigmoidçš„cppæ–‡ä»¶é‡Œä¸»è¦ç»™äº†ä¸‰ä¸ªå‡½æ•°çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯sigmoidå‡½æ•°ï¼Œforward_cpu, backward_cpu,åœ¨cppæ–‡ä»¶é‡Œåªå®ç°äº†ç®—æ³•çš„CPUç‰ˆæœ¬ï¼Œè‡³äºGPUç‰ˆæœ¬çš„å‡½æ•°å®ç°æ”¾åœ¨.cuæ–‡ä»¶é‡Œé¢ã€‚</p>
<!--more-->
<pre><code class="language-cpp">template &lt;typename Dtype&gt;
inline Dtype sigmoid(Dtype x) {
  return 0.5 * tanh(0.5 * x) + 0.5;
}

template &lt;typename Dtype&gt;
void SigmoidLayer&lt;Dtype&gt;::Forward_cpu(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom,
    const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top) {
  const Dtype* bottom_data = bottom[0]-&gt;cpu_data();
  Dtype* top_data = top[0]-&gt;mutable_cpu_data();
  const int count = bottom[0]-&gt;count();
  for (int i = 0; i &lt; count; ++i) {
    top_data[i] = sigmoid(bottom_data[i]);
  }
}

template &lt;typename Dtype&gt;
void SigmoidLayer&lt;Dtype&gt;::Backward_cpu(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top,
    const vector&lt;bool&gt;&amp; propagate_down,
    const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom) {
  if (propagate_down[0]) {
    const Dtype* top_data = top[0]-&gt;cpu_data();
    const Dtype* top_diff = top[0]-&gt;cpu_diff();
    Dtype* bottom_diff = bottom[0]-&gt;mutable_cpu_diff();
    const int count = bottom[0]-&gt;count();
    for (int i = 0; i &lt; count; ++i) {
      const Dtype sigmoid_x = top_data[i];
      bottom_diff[i] = top_diff[i] * sigmoid_x * (1. - sigmoid_x);
    }
  }
}
</code></pre>
<p><strong>sigmoidå‡½æ•°</strong><br>
æ³¨æ„è¿™é‡Œçš„sigmoidå‡½æ•°ä¸æ ‡å‡†çš„å®šä¹‰ä¸å¤ªä¸€æ ·ã€‚å‚è§ufldé‡Œé¢çš„å®šä¹‰<br>
[ç¥ç»ç½‘ç»œUFLD</p>
<p>](http://ufldl.stanford.edu/wiki/index.php/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C)</p>
<p>è€Œåœ¨è¿™é‡Œ sigmoid = 0.5 * tanh(0.5 * x) + 0.5, sigmoidå˜åŒ–èŒƒå›´ä¸ºä»0-1, tanhä»-1åˆ°1ï¼Œä¹˜äº0.5å†åŠ ä¸Š0.5ä¸¤è€…å˜åŒ–èŒƒå›´å°±ä¸€æ ·äº†ã€‚<br>
<strong>forward_cpu</strong><br>
è¿™ä¸ªå¾ˆå®¹æ˜“å°±èƒ½çœ‹æ‡‚ï¼Œå°±æ˜¯å¯¹æ¯ä¸€ä¸ªbottomå…ƒç´ è®¡ç®—sigmoidå°±å¾—åˆ°æ¥topçš„å…ƒç´ ã€‚</p>
<p><strong>backward_cpu</strong><br>
å‘ç°æ–°ç‰ˆçš„ä»£ç çœŸçš„å¾ˆå¥½æ‡‚ï¼Œsigmoidå‡½æ•°çš„åˆ°å‡½æ•°æ˜¯sigmoid*(1-sigmoid) , æ‰€ä»¥è¿™é‡Œå°±ç›´æ¥åˆ©ç”¨æ¥ã€‚å…¶ä¸­propagate_downè¡¨æ˜è¿™ä¸€å±‚æ˜¯å¦è¦åä¼ ã€‚</p>
<h3 id="softmaxlayer">softmaxlayer</h3>
<p>è¿™æ®µä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæ¯”è¾ƒå¥½çš„æ³¨é‡Šå¦‚ä¸‹ã€‚ä½†æ˜¯è¿™ä¸ªæ³¨é‡Šé’ˆå¯¹çš„ä»£ç ç‰ˆæœ¬æ¯”è¾ƒè€ã€‚<br>
<a href="http://blog.csdn.net/u010668083/article/details/44857455">caffeæ·±åº¦å­¦ä¹ ç½‘ç»œsoftmaxå±‚ä»£ç æ³¨é‡Š</a></p>
<p>è¿™é‡Œæˆ‘ä»¬åˆ†ææ¯”è¾ƒæ–°çš„ä»£ç ï¼Œå½“å‰(20170622)æ¯”è¾ƒæ–°çš„ä»£ç æ˜¯20161202æäº¤çš„ä»£ç ï¼Œç»“æ„å¦‚ä¸‹</p>
<pre><code class="language-cpp">/template &lt;typename Dtype&gt;
void SoftmaxLayer&lt;Dtype&gt;::Reshape(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom,
      const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top) {
  softmax_axis_ =
      bottom[0]-&gt;CanonicalAxisIndex(this-&gt;layer_param_.softmax_param().axis());
  //softmaxå±‚çš„è¾“å‡ºåº”è¯¥ä¸è¾“å…¥å±‚ä¸€è‡´
  top[0]-&gt;ReshapeLike(*bottom[0]);
  vector&lt;int&gt; mult_dims(1, bottom[0]-&gt;shape(softmax_axis_));
  sum_multiplier_.Reshape(mult_dims);
  Dtype* multiplier_data = sum_multiplier_.mutable_cpu_data();
  caffe_set(sum_multiplier_.count(), Dtype(1), multiplier_data);
  outer_num_ = bottom[0]-&gt;count(0, softmax_axis_);
  inner_num_ = bottom[0]-&gt;count(softmax_axis_ + 1);
  vector&lt;int&gt; scale_dims = bottom[0]-&gt;shape();
  // scale_å°ºå¯¸ä¸ºï¼šnum*1*height*width
  scale_dims[softmax_axis_] = 1;
  scale_.Reshape(scale_dims);
}
//å‰å‘è®¡ç®—ï¼Œå¾—åˆ°softmaxçš„å€¼
template &lt;typename Dtype&gt;
void SoftmaxLayer&lt;Dtype&gt;::Forward_cpu(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom,
    const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top) {
  const Dtype* bottom_data = bottom[0]-&gt;cpu_data();
  Dtype* top_data = top[0]-&gt;mutable_cpu_data();
  Dtype* scale_data = scale_.mutable_cpu_data();
  int channels = bottom[0]-&gt;shape(softmax_axis_);
  int dim = bottom[0]-&gt;count() / outer_num_;
  caffe_copy(bottom[0]-&gt;count(), bottom_data, top_data);
  // We need to subtract the max to avoid numerical issues, compute the exp,
  // and then normalize.
  // å…ˆæ‰¾åˆ°æœ€å¤§å€¼
  for (int i = 0; i &lt; outer_num_; ++i) {//outer_numå°±æ˜¯numè¾“å‡ºæ•°æ®çš„æ•°ç›®
    // initialize scale_data to the first plane
    caffe_copy(inner_num_, bottom_data + i * dim, scale_data);//dimè¡¨ç¤ºæ¯ä¸ªæ•°æ®æœ‰å¤šå°‘ä¸ªä¸åŒç±»åˆ«çš„å€¼.
    for (int j = 0; j &lt; channels; j++) {
      for (int k = 0; k &lt; inner_num_; k++) {
        scale_data[k] = std::max(scale_data[k],//æ¯ä¸ªå…ƒç´ è¡¨ç¤ºåº”è¯¥æ˜¯å½“å‰ä½ç½®ä¸­æ‰€æœ‰ç±»åˆ«å’Œchannelé‡Œé¢æœ€å¤§çš„é‚£ä¸€ä¸ªã€‚
            bottom_data[i * dim + j * inner_num_ + k]);
      }
    }
    // subtraction å‡å»æœ€å¤§å€¼ è¯¦ç»†åˆ†æè§åé¢ 
    caffe_cpu_gemm&lt;Dtype&gt;(CblasNoTrans, CblasNoTrans, channels, inner_num_,
        1, -1., sum_multiplier_.cpu_data(), scale_data, 1., top_data);
    // exponentiation æ±‚æŒ‡æ•°
    caffe_exp&lt;Dtype&gt;(dim, top_data, top_data);
    // sum after exp æ±‚å’Œ
    caffe_cpu_gemv&lt;Dtype&gt;(CblasTrans, channels, inner_num_, 1.,
        top_data, sum_multiplier_.cpu_data(), 0., scale_data);
    // division åšé™¤æ³•
    for (int j = 0; j &lt; channels; j++) {
      caffe_div(inner_num_, top_data, scale_data, top_data);
      top_data += inner_num_;
    }
  }
}

template &lt;typename Dtype&gt;
void SoftmaxLayer&lt;Dtype&gt;::Backward_cpu(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top,
    const vector&lt;bool&gt;&amp; propagate_down,
    const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom) {
  const Dtype* top_diff = top[0]-&gt;cpu_diff();
  const Dtype* top_data = top[0]-&gt;cpu_data();
  Dtype* bottom_diff = bottom[0]-&gt;mutable_cpu_diff();
  Dtype* scale_data = scale_.mutable_cpu_data();
  int channels = top[0]-&gt;shape(softmax_axis_);
  int dim = top[0]-&gt;count() / outer_num_;
  caffe_copy(top[0]-&gt;count(), top_diff, bottom_diff);
  for (int i = 0; i &lt; outer_num_; ++i) {
    // compute dot(top_diff, top_data) and subtract them from the bottom diff
	//è®¡ç®—top_diffä¸top_dataçš„ç‚¹é›†
    for (int k = 0; k &lt; inner_num_; ++k) {
      scale_data[k] = caffe_cpu_strided_dot&lt;Dtype&gt;(channels,
          bottom_diff + i * dim + k, inner_num_,
          top_data + i * dim + k, inner_num_);
    }
    // subtraction
    caffe_cpu_gemm&lt;Dtype&gt;(CblasNoTrans, CblasNoTrans, channels, inner_num_, 1,
        -1., sum_multiplier_.cpu_data(), scale_data, 1., bottom_diff + i * dim);
  }
  // elementwise multiplication
  caffe_mul(top[0]-&gt;count(), bottom_diff, top_data, bottom_diff);
}


#ifdef CPU_ONLY
STUB_GPU(SoftmaxLayer);
#endif

INSTANTIATE_CLASS(SoftmaxLayer);

</code></pre>
<p>**caffe_cpu_gemmå‡æ³• **<br>
åœ¨forward_cpuå‡½æ•°é‡Œåšå‡æ³•çš„æ—¶å€™è°ƒç”¨æ¥caffe_cpu_gemmå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å®ç°åœ¨ src/caffe/util/math_functions.cppé‡Œé¢<br>
<a href="http://blog.csdn.net/seven_first/article/details/47378697#1-caffecpugemm-%E5%87%BD%E6%95%B0">caffecpugemm-å‡½æ•°</a></p>
<pre><code class="language-cpp">template&lt;&gt;
void caffe_cpu_gemm&lt;float&gt;(const CBLAS_TRANSPOSE TransA,
    const CBLAS_TRANSPOSE TransB, const int M, const int N, const int K,
    const float alpha, const float* A, const float* B, const float beta,
    float* C) {
  int lda = (TransA == CblasNoTrans) ? K : M;
  int ldb = (TransB == CblasNoTrans) ? N : K;
  cblas_sgemm(CblasRowMajor, TransA, TransB, M, N, K, alpha, A, lda, B,
      ldb, beta, C, N);
}
</code></pre>
<blockquote>
<p>åŠŸèƒ½ï¼š C=alpha<em>A</em>B+beta*C<br>
A,B,C æ˜¯è¾“å…¥çŸ©é˜µï¼ˆä¸€ç»´æ•°ç»„æ ¼å¼ï¼‰<br>
CblasRowMajor :æ•°æ®æ˜¯è¡Œä¸»åºçš„ï¼ˆäºŒç»´æ•°æ®ä¹Ÿæ˜¯ç”¨ä¸€ç»´æ•°ç»„å‚¨å­˜çš„ï¼‰<br>
TransA, TransBï¼šæ˜¯å¦è¦å¯¹Aå’ŒBåšè½¬ç½®æ“ä½œï¼ˆCblasTrans CblasNoTransï¼‰<br>
Mï¼š Aã€C çš„è¡Œæ•°<br>
Nï¼š Bã€C çš„åˆ—æ•°<br>
Kï¼š A çš„åˆ—æ•°ï¼Œ B çš„è¡Œæ•°<br>
lda ï¼š Açš„åˆ—æ•°ï¼ˆä¸åšè½¬ç½®ï¼‰è¡Œæ•°ï¼ˆåšè½¬ç½®ï¼‰<br>
ldbï¼š Bçš„åˆ—æ•°ï¼ˆä¸åšè½¬ç½®ï¼‰è¡Œæ•°ï¼ˆåšè½¬ç½®ï¼‰</p>
</blockquote>
<p>æ‰€ä»¥è¿™é‡Œæ±‚å‡æ³•ï¼š</p>
<pre><code class="language-cpp">    caffe_cpu_gemm&lt;Dtype&gt;(CblasNoTrans, CblasNoTrans, channels, inner_num_,
        1, -1., sum_multiplier_.cpu_data(), scale_data, 1., top_data);
</code></pre>
<p>å°±æ˜¯ï¼š <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>=</mo><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>âˆ’</mo><mn>1</mn><mo>âˆ—</mo><mi>s</mi><mi>u</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi>i</mi><mi>p</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>p</mi><mi>u</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>(</mo><mo>)</mo><mo>âˆ—</mo><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">top\_data = top\_data - 1* sum\_multiplier\_.cpu\_data()*scale\_data</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">m</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord">.</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span></span></span></span>ï¼Œ è¿™é‡Œç”¨top_dataæ¥å‡è€Œä¸ç”¨bottomä¸€æ–¹é¢æ˜¯å› ä¸ºbottomæ˜¯constçš„ï¼Œå–çš„æ˜¯cpu_data(), è€Œtop_dataæ˜¯mutable_cpu_data,å¦ä¸€æ–¹é¢ä¹‹å‰å·²ç»æŠŠæ•°æ®ä»bottomæ‹·è´åˆ°topé‡Œé¢å»äº†ã€‚</p>
<p>è€Œåœ¨back_wardå‡½æ•°é‡Œé¢ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªå‡½æ•°ã€‚</p>
<pre><code class="language-cpp">caffe_cpu_gemm&lt;Dtype&gt;(CblasNoTrans, CblasNoTrans, channels, inner_num_, 1,
        -1., sum_multiplier_.cpu_data(), scale_data, 1., bottom_diff + i * dim);
</code></pre>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>o</mi><mi>t</mi><mi>t</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mo>+</mo><mi>i</mi><mo>âˆ—</mo><mi>d</mi><mi>i</mi><mi>m</mi><mo>=</mo><mi>b</mi><mi>o</mi><mi>t</mi><mi>t</mi><mi>o</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>i</mi><mi>f</mi><mi>f</mi><mo>+</mo><mi>i</mi><mo>âˆ—</mo><mi>d</mi><mi>i</mi><mi>m</mi><mo>âˆ’</mo><mi>s</mi><mi>u</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi>i</mi><mi>p</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>p</mi><msub><mi>u</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mo>(</mo><mo>)</mo><mo>âˆ—</mo><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">bottom\_diff + i * dim = bottom\_diff + i * dim - sum\_multiplier\_.cpu_data() * scale\_data
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">m</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord">.</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span></span></span></span></span></p>
<p><strong>caffe_expæŒ‡æ•°</strong><br>
caffe_expå‡½æ•°æ˜¯ç”¨æ¥æ±‚æŒ‡æ•°çš„ï¼Œå…¶ä¸­ä¸€ä¸ªå®ç°æ˜¯è¿™æ ·çš„ã€‚</p>
<pre><code class="language-cpp">template &lt;&gt;
void caffe_exp&lt;float&gt;(const int n, const float* a, float* y) {
  vsExp(n, a, y);
}
</code></pre>
<blockquote>
<p>åŠŸèƒ½ï¼š  y[i] = exp(a[i] )</p>
</blockquote>
<p>æ‰€ä»¥ï¼Œ forward_cpué‡Œé¢çš„æŒ‡æ•°å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p>
<pre><code>caffe_exp&lt;Dtype&gt;(dim, top_data, top_data);
</code></pre>
<p>top_data[i] = exp(topdata[i])<br>
<strong>caffe_cpu_gemvæ±‚å’Œ</strong></p>
<pre><code class="language-cpp">template &lt;&gt;
void caffe_cpu_gemv&lt;float&gt;(const CBLAS_TRANSPOSE TransA, const int M,
    const int N, const float alpha, const float* A, const float* x,
    const float beta, float* y) {
  cblas_sgemv(CblasRowMajor, TransA, M, N, alpha, A, N, x, 1, beta, y, 1);
}
</code></pre>
<blockquote>
<p>åŠŸèƒ½ï¼š y=alpha<em>A</em>x+beta*y<br>
å…¶ä¸­Xå’ŒYæ˜¯å‘é‡ï¼ŒA æ˜¯çŸ©é˜µ<br>
Mï¼šA çš„è¡Œæ•°<br>
Nï¼šA çš„åˆ—æ•°<br>
cblas_sgemv ä¸­çš„ å‚æ•°1 è¡¨ç¤ºå¯¹Xå’ŒYçš„æ¯ä¸ªå…ƒç´ éƒ½è¿›è¡Œæ“ä½œ</p>
</blockquote>
<p>forward_cpué‡Œé¢çš„æ±‚å’Œå°±å¾ˆå®¹æ˜“ç†è§£äº†</p>
<pre><code class="language-cpp">    // sum after exp æ±‚å’Œ
    caffe_cpu_gemv&lt;Dtype&gt;(CblasTrans, channels, inner_num_, 1.,
        top_data, sum_multiplier_.cpu_data(), 0., scale_data);

</code></pre>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>=</mo><mo>âˆ‘</mo><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo>âˆ—</mo><mi>s</mi><mi>u</mi><mi>m</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>u</mi><mi>l</mi><mi>t</mi><mi>i</mi><mi>p</mi><mi>l</mi><mi>i</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">_</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>p</mi><mi>u</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>(</mo><mo>)</mo><mo>[</mo><mi>i</mi><mo>]</mo><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">scale\_data =\sum top\_data[i]*sum\_multiplier\_.cpu\_data()[i];</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00444em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">âˆ‘</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">m</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">i</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord">.</span><span class="mord mathdefault">c</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mclose">)</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mpunct">;</span></span></span></span></p>
<p><strong>caffe_divé™¤æ³•</strong></p>
<pre><code class="language-cpp">template &lt;&gt;
void caffe_div&lt;float&gt;(const int n, const float* a, const float* b,
    float* y) {
  vsDiv(n, a, b, y);
}

</code></pre>
<blockquote>
<p>åŠŸèƒ½ y[i] = a[i] / b[i]</p>
</blockquote>
<pre><code class="language-cpp">    // division åšé™¤æ³•
    for (int j = 0; j &lt; channels; j++) {
      caffe_div(inner_num_, top_data, scale_data, top_data);
      top_data += inner_num_;

</code></pre>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo>=</mo><mi>t</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>[</mo><mi>i</mi><mo>]</mo><mi mathvariant="normal">/</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo separator="true">;</mo></mrow><annotation encoding="application/x-tex">top\_data[i] = top\_data[i] / scale\_data[i];</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault">p</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mord">/</span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathdefault">d</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mpunct">;</span></span></span></span></p>
<p><strong>caffe_cpu_strided_dot</strong></p>
<pre><code class="language-cpp">template &lt;&gt;
double caffe_cpu_strided_dot&lt;double&gt;(const int n, const double* x,
    const int incx, const double* y, const int incy) {
  return cblas_ddot(n, x, incx, y, incy);
}

</code></pre>
<blockquote>
<p>åŠŸèƒ½ï¼š è¿”å› vector X å’Œ vector Y çš„å†…ç§¯ã€‚<br>
incxï¼Œ incy ï¼š æ­¥é•¿ï¼Œå³æ¯éš”incx æˆ– incy ä¸ªelement è¿›è¡Œæ“ä½œã€‚</p>
</blockquote>
<p><strong>caffe_mul</strong></p>
<pre><code class="language-cpp">template &lt;&gt;
void caffe_mul&lt;float&gt;(const int n, const float* a, const float* b,
    float* y) {
  vsMul(n, a, b, y);
}

</code></pre>
<p>åŠŸèƒ½ <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo>=</mo><mi>a</mi><mo>[</mo><mi>i</mi><mo>]</mo><mo>âˆ—</mo><mi>b</mi><mo>[</mo><mi>i</mi><mo>]</mo></mrow><annotation encoding="application/x-tex">y[i]=a[i] * b[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span></span></span></span></p>
<pre><code class="language-cpp"> caffe_mul(top[0]-&gt;count(), bottom_diff, top_data, bottom_diff);

</code></pre>
<p>bottom_diff[i] = bottom_diff[i] * top_data[i]</p>
<p><strong>åå‘ä¼ æ’­å…¬å¼æ¨å¯¼</strong><br>
<a href="https://www.zhihu.com/question/28927103">Caffe Softmaxå±‚çš„å®ç°åŸç†,çŸ¥ä¹</a></p>
<p>çœ‹å®Œsoftmax layerçš„å®ç°ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹SoftmaxWithLossLayerçš„ä»£ç å®ç°ã€‚</p>
<h2 id="å·ç§¯å±‚">å·ç§¯å±‚</h2>
<h3 id="è®¡ç®—é‡ä¸å‚æ•°é‡">è®¡ç®—é‡ä¸å‚æ•°é‡</h3>
<p>æ¯ä¸ªæ ·æœ¬åšä¸€æ¬¡å‰å‘ä¼ æ’­æ—¶å·ç§¯è®¡ç®—é‡ä¸ºï¼š $ i* j<em>M</em>N<em>K</em>L  $ ï¼Œå…¶ä¸­<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mo>âˆ—</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i*j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span>æ˜¯å·ç§¯æ ¸çš„å¤§å°ï¼Œ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo>âˆ—</mo><mi>L</mi></mrow><annotation encoding="application/x-tex">M*L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span></span></span></span>æ˜¯è¾“å‡ºç‰¹å¾å›¾çš„å¤§å°ï¼ŒKæ˜¯è¾“å…¥ç‰¹å¾å›¾é€šé“æ•°ï¼ŒLæ˜¯è¾“å‡ºç‰¹å¾å›¾é€šé“æ•°ã€‚</p>
<p>å‚æ•°é‡ä¸ºï¼š$ i<em>J</em>K*L $</p>
<p>æ‰€ä»¥æœ‰ä¸ªæ¯”ä¾‹å«åšè®¡ç®—é‡å‚æ•°é‡ä¹‹æ¯” CPRï¼Œå¦‚æœåœ¨å‰é¦ˆæ—¶æ¯ä¸ªæ‰¹æ¬¡batch_size = B, åˆ™è¡¨ç¤ºå°†Bä¸ªè¾“å…¥åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µè¿›è¡Œè®¡ç®—ï¼Œé‚£ä¹ˆç›¸å½“äºæ¯æ¬¡çš„è¾“å‡ºç‰¹å¾å›¾å¢å¤§æ¥Bå€ï¼Œæ‰€ä»¥CPRæå‡æ¥Bå€ï¼Œä¹Ÿå°±æ˜¯ï¼Œæ¯æ¬¡è®¡ç®—çš„æ—¶å€™å‚æ•°é‡å¤åˆ©ç”¨ç‡æé«˜æ¥Bå€ã€‚</p>
<p>å·ç§¯å±‚ï¼šå±€éƒ¨äº’è¿ï¼Œæƒå€¼å…±äº«ï¼Œ</p>
<h3 id="æºç å­¦ä¹ ">æºç å­¦ä¹ </h3>
<p>å…ˆç”¨grepå‡½æ•°åœ¨caffeæ ¹ç›®å½•ä¸‹æœç´¢ä¸€ä¸‹åŒ…å«ConvolutionLayerçš„æ–‡ä»¶æœ‰å“ªäº›ï¼Œç„¶åä»å¤´æ–‡ä»¶å…¥æ‰‹æ…¢æ…¢åˆ†æï¼Œä¸‹é¢æ˜¯ç»“æœï¼Œç²¾ç®€æ¥ä¸€äº›æ— æ•ˆæˆåˆ†ï¼Œåœ¨caffeçš„includeæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">grep -n -H -R &quot;ConvolutionLayer&quot;

</code></pre>
<p>-nè¡¨ç¤ºæ˜¾ç¤ºè¡Œå·ï¼Œ-Hè¡¨ç¤ºæ˜¾ç¤ºæ–‡ä»¶åï¼Œ-Rè¡¨ç¤ºé€’å½’æŸ¥æ‰¾ åé¢éƒ¨åˆ†è¡¨ç¤ºæŸ¥æ‰¾çš„å†…å®¹<br>
ç»“æœå¦‚ä¸‹</p>
<pre><code class="language-bash">caffe/layer_factory.hpp:31: * (for example, when your layer has multiple backends, see GetConvolutionLayer
caffe/layers/base_conv_layer.hpp:15: *        ConvolutionLayer and DeconvolutionLayer.
caffe/layers/base_conv_layer.hpp:18:class BaseConvolutionLayer : public Layer&lt;Dtype&gt; {
caffe/layers/base_conv_layer.hpp:20:  explicit BaseConvolutionLayer(const LayerParameter&amp; param)
caffe/layers/deconv_layer.hpp:17: *        opposite sense as ConvolutionLayer.
caffe/layers/deconv_layer.hpp:19: *   ConvolutionLayer computes each output value by dotting an input window with
caffe/layers/deconv_layer.hpp:22: *   DeconvolutionLayer is ConvolutionLayer with the forward and backward passes
caffe/layers/deconv_layer.hpp:24: *   parameters, but they take the opposite sense as in ConvolutionLayer (so
caffe/layers/deconv_layer.hpp:29:class DeconvolutionLayer : public BaseConvolutionLayer&lt;Dtype&gt; {
caffe/layers/deconv_layer.hpp:32:      : BaseConvolutionLayer&lt;Dtype&gt;(param) {}
caffe/layers/im2col_layer.hpp:14: *        column vectors.  Used by ConvolutionLayer to perform convolution
caffe/layers/conv_layer.hpp:31:class ConvolutionLayer : public BaseConvolutionLayer&lt;Dtype&gt; {
caffe/layers/conv_layer.hpp:35:   *    with ConvolutionLayer options:
caffe/layers/conv_layer.hpp:64:  explicit ConvolutionLayer(const LayerParameter&amp; param)
caffe/layers/conv_layer.hpp:65:      : BaseConvolutionLayer&lt;Dtype&gt;(param) {}
caffe/layers/cudnn_conv_layer.hpp:16: * @brief cuDNN implementation of ConvolutionLayer.
caffe/layers/cudnn_conv_layer.hpp:17: *        Fallback to ConvolutionLayer for CPU mode.
caffe/layers/cudnn_conv_layer.hpp:30:class CuDNNConvolutionLayer : public ConvolutionLayer&lt;Dtype&gt; {
caffe/layers/cudnn_conv_layer.hpp:32:  explicit CuDNNConvolutionLayer(const LayerParameter&amp; param)
caffe/layers/cudnn_conv_layer.hpp:33:      : ConvolutionLayer&lt;Dtype&gt;(param), handles_setup_(false) {}
caffe/layers/cudnn_conv_layer.hpp:38:  virtual ~CuDNNConvolutionLayer();


</code></pre>
<p>ä¸»è¦æœ‰ä¸‰ä¸ªç±»åŒ…å«è¿™ä¸ªå·ç§¯å±‚çš„å®ç°ï¼š<br>
base_conv_layerï¼šä¸»è¦æ˜¯å·ç§¯å±‚åŸºç±»çš„å®ç°<br>
deconv_layerï¼š ç›®æµ‹æ˜¯åå‘ä¼ æ’­æ—¶å€™çš„å·ç§¯å±‚çš„é€†å‘è¿‡ç¨‹<br>
cudnn_conv_layerï¼šç›®æµ‹æ˜¯cudnnå®ç°çš„å·ç§¯å±‚ç‰ˆæœ¬ç»§æ‰¿è‡ªBaseConvolutionLayer,GPUç‰ˆæœ¬</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ‰“å¼€è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œè·³è½¬åˆ°ç›¸å…³è¡Œï¼Œè¯¦ç»†çœ‹ä¸€ä¸‹ã€‚</p>
<pre><code>class BaseConvolutionLayer : public Layer&lt;Dtype&gt; {
 public:
  explicit BaseConvolutionLayer(const LayerParameter&amp; param)
      : Layer&lt;Dtype&gt;(param) {}
  virtual void LayerSetUp(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom,
      const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top);
  virtual void Reshape(const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; bottom,
      const vector&lt;Blob&lt;Dtype&gt;*&gt;&amp; top);

  virtual inline int MinBottomBlobs() const { return 1; }
  virtual inline int MinTopBlobs() const { return 1; }
  virtual inline bool EqualNumBottomTopBlobs() const { return true; }

 protected:
  // Helper functions that abstract away the column buffer and gemm arguments.
  // The last argument in forward_cpu_gemm is so that we can skip the im2col if
  // we just called weight_cpu_gemm with the same input.
  void forward_cpu_gemm(const Dtype* input, const Dtype* weights,
      Dtype* output, bool skip_im2col = false);
  void forward_cpu_bias(Dtype* output, const Dtype* bias);
  void backward_cpu_gemm(const Dtype* input, const Dtype* weights,
      Dtype* output);
  void weight_cpu_gemm(const Dtype* input, const Dtype* output, Dtype*
      weights);
  void backward_cpu_bias(Dtype* bias, const Dtype* input);

#ifndef CPU_ONLY
  void forward_gpu_gemm(const Dtype* col_input, const Dtype* weights,
      Dtype* output, bool skip_im2col = false);
  void forward_gpu_bias(Dtype* output, const Dtype* bias);
  void backward_gpu_gemm(const Dtype* input, const Dtype* weights,
      Dtype* col_output);
  void weight_gpu_gemm(const Dtype* col_input, const Dtype* output, Dtype*
      weights);
  void backward_gpu_bias(Dtype* bias, const Dtype* input);
#endif

</code></pre>
<p>è¿™é‡Œç»™å‡ºæ¥CPUå’ŒGPUç‰ˆæœ¬çš„ä»£ç çš„å£°æ˜ï¼Œè¿™äº›ä»£ç æ¯”è¾ƒåº•å±‚ï¼Œå…ˆæ”¾ä¸€æ”¾ä»¥åå†çœ‹ã€‚<br>
forward_cpu_gemm:çŒœæµ‹å¯èƒ½æ˜¯å‰é¦ˆè¿‡ç¨‹è®¡ç®—weightéƒ¨åˆ†ï¼Œæ¥çœ‹çœ‹CPPé‡Œé¢çš„å®ç°å§ã€‚</p>
<p>åœ¨BaseConvolutionLayerä¸­çš„å·ç§¯çš„å®ç°ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°å°±æ˜¯<strong>im2colä»¥åŠcol2imï¼Œim2colndä»¥åŠcol2imnd</strong>ã€‚å‰é¢çš„ä¸¤ä¸ªå‡½æ•°æ˜¯äºŒç»´å·ç§¯çš„æ­£å‘å’Œé€†å‘è¿‡ç¨‹ï¼Œè€Œåé¢çš„ä¸¤ä¸ªå‡½æ•°æ˜¯nç»´å·ç§¯çš„æ­£å‘å’Œé€†å‘è¿‡ç¨‹ã€‚</p>
<pre><code class="language-cpp">void BaseConvolutionLayer&lt;Dtype&gt;::forward_cpu_gemm(const Dtype* input,
    const Dtype* weights, Dtype* output, bool skip_im2col) {
  const Dtype* col_buff = input;
  if (!is_1x1_) {
    if (!skip_im2col) {
	  // å¦‚æœæ²¡æœ‰1x1å·ç§¯ï¼Œä¹Ÿæ²¡æœ‰skip_im2col  
      // åˆ™ä½¿ç”¨conv_im2col_cpuå¯¹ä½¿ç”¨å·ç§¯æ ¸æ»‘åŠ¨è¿‡ç¨‹ä¸­çš„æ¯ä¸€ä¸ªkernelå¤§å°çš„å›¾åƒå—  
      // å˜æˆä¸€ä¸ªåˆ—å‘é‡ï¼Œå½¢æˆä¸€ä¸ªheight=kernel_dim_  
      // width = å·ç§¯åå›¾åƒheght*å·ç§¯åå›¾åƒwidth  
      conv_im2col_cpu(input, col_buffer_.mutable_cpu_data());
    }
    col_buff = col_buffer_.cpu_data();
  }
  for (int g = 0; g &lt; group_; ++g) {
    caffe_cpu_gemm&lt;Dtype&gt;(CblasNoTrans, CblasNoTrans, conv_out_channels_ /
        group_, conv_out_spatial_dim_, kernel_dim_,
        (Dtype)1., weights + weight_offset_ * g, col_buff + col_offset_ * g,
        (Dtype)0., output + output_offset_ * g);
  }
}


</code></pre>
<p><strong>å‚è€ƒèµ„æ–™</strong><br>
<a href="http://blog.csdn.net/xizero00/article/details/51049858"> caffeä»£ç é˜…è¯»10ï¼šCaffeä¸­å·ç§¯çš„å®ç°ç»†èŠ‚</a></p>
<h1 id="æ•°æ®é›†">æ•°æ®é›†</h1>
<h2 id="ç”Ÿæˆæ•°æ®é›†çš„å‡å€¼æ–‡ä»¶">ç”Ÿæˆæ•°æ®é›†çš„å‡å€¼æ–‡ä»¶</h2>
<p>è¿™é‡Œè®¡ç®—å›¾åƒçš„å‡å€¼ä½¿ç”¨çš„æ˜¯pper_image_meanæ–¹æ³•ï¼Œåœ¨natural imagesä¸Šè®­ç»ƒçš„æ—¶å€™ï¼Œè¿™ç§æ–¹å¼æ¯”è¾ƒå¥½ï¼Œä»¥imagenetæ•°æ®é›†ä¸ºä¾‹ï¼Œcaffeåœ¨ä½¿ç”¨imagenetæ•°æ®é›†çš„æ—¶å€™éœ€è¦è®¡ç®—å‡å€¼æ–‡ä»¶ï¼Œè¯¦ç»†è§ [python-caffe</p>
<p>](https://github.com/DragonFive/deep-learning-exercise/blob/master/caffe_python1.ipynb)</p>
<h2 id="caffe-blob">caffe-blob</h2>
<p><a href="http://blog.csdn.net/chenriwei2/article/details/46367023">ã€Caffeä»£ç è§£æã€‘Blob</a><br>
<a href="http://blog.csdn.net/lingerlanlan/article/details/24379689">caffeæºç åˆ†æ--Blobç±»ä»£ç ç ”ç©¶</a><br>
<a href="http://www.cnblogs.com/louyihang-loves-baiyan/p/5149628.html">Caffeæºç è§£æ1ï¼šBlob</a></p>
<h3 id="ç»“æ„ä½“åˆ†æ">ç»“æ„ä½“åˆ†æ</h3>
<p>Blob æ˜¯Caffeä½œä¸ºæ•°æ®ä¼ è¾“çš„åª’ä»‹ï¼Œæ— è®ºæ˜¯ç½‘ç»œæƒé‡å‚æ•°ï¼Œè¿˜æ˜¯è¾“å…¥æ•°æ®ï¼Œéƒ½æ˜¯è½¬åŒ–ä¸ºBlobæ•°æ®ç»“æ„æ¥å­˜å‚¨ï¼Œç½‘ç»œï¼Œæ±‚è§£å™¨ç­‰éƒ½æ˜¯ç›´æ¥ä¸æ­¤ç»“æ„æ‰“äº¤é“çš„ã€‚</p>
<p>4çº¬çš„ç»“æ„ä½“ï¼ˆåŒ…å«æ•°æ®å’Œæ¢¯åº¦)ï¼Œå…¶4ç»´ç»“æ„é€šè¿‡shapeå±æ€§å¾—ä»¥è®¡ç®—å‡ºæ¥.</p>
<p><strong>æˆå‘˜å˜é‡</strong></p>
<pre><code class="language-cpp"> protected:
  shared_ptr&lt;SyncedMemory&gt; data_;// å­˜æ”¾æ•°æ®
  shared_ptr&lt;SyncedMemory&gt; diff_;//å­˜æ”¾æ¢¯åº¦
  vector&lt;int&gt; shape_; //å­˜æ”¾å½¢çŠ¶
  int count_; //æ•°æ®ä¸ªæ•°
  int capacity_; //æ•°æ®å®¹é‡

</code></pre>
<p><strong>æˆå‘˜å‡½æ•°</strong></p>
<pre><code>  const Dtype* cpu_data() const;			 //cpuä½¿ç”¨çš„æ•°æ®
  void set_cpu_data(Dtype* data);		//ç”¨æ•°æ®å—çš„å€¼æ¥blobé‡Œé¢çš„dataã€‚
  const Dtype* gpu_data() const;		//è¿”å›ä¸å¯æ›´æ”¹çš„æŒ‡é’ˆï¼Œä¸‹åŒ
  const Dtype* cpu_diff() const;
  const Dtype* gpu_diff() const;
  Dtype* mutable_cpu_data();    		//è¿”å›å¯æ›´æ”¹çš„æŒ‡é’ˆï¼Œä¸‹åŒ
  Dtype* mutable_gpu_data();
  Dtype* mutable_cpu_diff();
  Dtype* mutable_gpu_diff();
  
  int offset(const int n, const int c = 0, const int h = 0,const int w = 0) const
// é€šè¿‡n,c,h,w 4ä¸ªå‚æ•°æ¥è®¡ç®—ä¸€ç»´å‘é‡çš„åç§»é‡ã€‚

Dtype data_at(const int n, const int c, const int h,const int w) const//é€šè¿‡n,c,h,w 4ä¸ªå‚æ•°æ¥æ¥è·å–è¯¥å‘é‡ä½ç½®ä¸Šçš„å€¼ã€‚

Dtype diff_at(const int n, const int c, const int h,const int w) const//åŒä¸Š

inline const shared_ptr&lt;SyncedMemory&gt;&amp; data() const {
    CHECK(data_);
    return data_;			//è¿”å›æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹
  }

inline const shared_ptr&lt;SyncedMemory&gt;&amp; diff() const {
    CHECK(diff_);
    return diff_;			//è¿”å›æ¢¯åº¦ï¼Œä¸èƒ½ä¿®æ”¹
  }

Reshape(...)//reshape æœ‰å¤šç§å¤šæ€çš„å®ç°ï¼Œå¯ä»¥æ˜¯å››ä¸ªæ•°å­—ï¼Œé•¿åº¦ä¸ºå››çš„vectorï¼Œå…¶å®ƒblobç­‰ã€‚

if (count_ &gt; capacity_) {
    capacity_ = count_;
    data_.reset(new SyncedMemory(capacity_ * sizeof(Dtype)));
    diff_.reset(new SyncedMemory(capacity_ * sizeof(Dtype)));
  }//å½“ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™ï¼Œéœ€è¦æ‰©å¤§å®¹é‡ï¼Œresetã€‚


</code></pre>
<p>å‡½æ•°åä¸­å¸¦mutableçš„è¡¨ç¤ºå¯ä»¥å¯¹è¿”å›çš„æŒ‡é’ˆå†…å®¹è¿›è¡Œä¿®æ”¹ã€‚</p>
<h1 id="caffeå­¦ä¹ èµ„æ–™æ”¶é›†">caffeå­¦ä¹ èµ„æ–™æ”¶é›†</h1>
<p><a href="https://absentm.github.io/2016/05/14/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0Caffe%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E9%9B%86%E5%90%88/">æ·±åº¦å­¦ä¹ Caffeç³»åˆ—æ•™ç¨‹é›†åˆ</a></p>
<p><a href="http://blog.csdn.net/xizero00/article/details/50886829">caffeä»£ç é˜…è¯»1ï¼šblobçš„å®ç°ç»†èŠ‚-2016.3.14</a></p>
<p><a href="https://yufeigan.github.io/">ç”˜å®‡é£</a></p>
<p><a href="https://zhuanlan.zhihu.com/Edison-G">è®¡ç®—æœºè§†è§‰æˆ˜é˜Ÿ</a></p>
<p><a href="http://blog.163.com/yuyang_tech/blog/static/2160500832015713105052452/">caffeæºç ç®€å•è§£æâ€”â€”Layerå±‚  </a></p>
<p><a href="http://blog.csdn.net/kkk584520/article/details/41681085">Caffeä»£ç å¯¼è¯»ï¼ˆ0ï¼‰ï¼šè·¯çº¿å›¾</a></p>
<p><a href="https://www.zhihu.com/question/27982282">çŸ¥ä¹é—®é¢˜-æ·±åº¦å­¦ä¹ caffeçš„ä»£ç æ€ä¹ˆè¯»ï¼Ÿ</a></p>
<p><a href="http://www.cnblogs.com/louyihang-loves-baiyan/p/5149628.html">Caffeæºç è§£æ1ï¼šBlob</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/24343706">æ·±åº¦å­¦ä¹ å¤§è®²å ‚â€”â€”æ·±åº¦å­¦ä¹ æ¡†æ¶Caffeæºç è§£æ</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/24709689">Caffeä»£ç å¤œè¯1</a></p>
<p><a href="http://blog.leanote.com/post/fishing_piggy/Caffe%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89">Caffeæºç åˆ†æï¼ˆä¸€ï¼‰</a></p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hello Gridea]]></title>
        <id>https://DragonFive.github.io//post/hello-gridea</id>
        <link href="https://DragonFive.github.io//post/hello-gridea">
        </link>
        <updated>2012-12-12T16:00:00.000Z</updated>
        <summary type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
]]></summary>
        <content type="html"><![CDATA[<p>ğŸ‘  æ¬¢è¿ä½¿ç”¨ <strong>Gridea</strong> ï¼<br>
âœï¸  <strong>Gridea</strong> ä¸€ä¸ªé™æ€åšå®¢å†™ä½œå®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥è®°å½•ä½ çš„ç”Ÿæ´»ã€å¿ƒæƒ…ã€çŸ¥è¯†ã€ç¬”è®°ã€åˆ›æ„... ...</p>
<!-- more -->
<p><a href="https://github.com/getgridea/gridea">Github</a><br>
<a href="http://hvenotes.fehey.com/">Gridea ä¸»é¡µ</a><br>
<a href="http://fehey.com/">ç¤ºä¾‹ç½‘ç«™</a></p>
<h2 id="ç‰¹æ€§">ç‰¹æ€§ğŸ‘‡</h2>
<p>ğŸ“  ä½ å¯ä»¥ä½¿ç”¨æœ€é…·çš„ <strong>Markdown</strong> è¯­æ³•ï¼Œè¿›è¡Œå¿«é€Ÿåˆ›ä½œ</p>
<p>ğŸŒ‰  ä½ å¯ä»¥ç»™æ–‡ç« é…ä¸Šç²¾ç¾çš„å°é¢å›¾å’Œåœ¨æ–‡ç« ä»»æ„ä½ç½®æ’å…¥å›¾ç‰‡</p>
<p>ğŸ·ï¸  ä½ å¯ä»¥å¯¹æ–‡ç« è¿›è¡Œæ ‡ç­¾åˆ†ç»„</p>
<p>ğŸ“‹  ä½ å¯ä»¥è‡ªå®šä¹‰èœå•ï¼Œç”šè‡³å¯ä»¥åˆ›å»ºå¤–éƒ¨é“¾æ¥èœå•</p>
<p>ğŸ’»  ä½ å¯ä»¥åœ¨ <strong>ğ–¶ğ—‚ğ—‡ğ–½ğ—ˆğ—ğ—Œ</strong> æˆ– <strong>ğ–¬ğ–ºğ–¼ğ–®ğ–²</strong> è®¾å¤‡ä¸Šä½¿ç”¨æ­¤å®¢æˆ·ç«¯</p>
<p>ğŸŒ  ä½ å¯ä»¥ä½¿ç”¨ <strong>ğ–¦ğ—‚ğ—ğ—ğ—ğ–» ğ–¯ğ–ºğ—€ğ–¾ğ—Œ</strong> æˆ– <strong>Coding Pages</strong> å‘ä¸–ç•Œå±•ç¤ºï¼Œæœªæ¥å°†æ”¯æŒæ›´å¤šå¹³å°</p>
<p>ğŸ’¬  ä½ å¯ä»¥è¿›è¡Œç®€å•çš„é…ç½®ï¼Œæ¥å…¥ <a href="https://github.com/gitalk/gitalk">Gitalk</a> æˆ– <a href="https://github.com/SukkaW/DisqusJS">DisqusJS</a> è¯„è®ºç³»ç»Ÿ</p>
<p>ğŸ‡¬ğŸ‡§  ä½ å¯ä»¥ä½¿ç”¨<strong>ä¸­æ–‡ç®€ä½“</strong>æˆ–<strong>è‹±è¯­</strong></p>
<p>ğŸŒ  ä½ å¯ä»¥ä»»æ„ä½¿ç”¨åº”ç”¨å†…é»˜è®¤ä¸»é¢˜æˆ–ä»»æ„ç¬¬ä¸‰æ–¹ä¸»é¢˜ï¼Œå¼ºå¤§çš„ä¸»é¢˜è‡ªå®šä¹‰èƒ½åŠ›</p>
<p>ğŸ–¥  ä½ å¯ä»¥è‡ªå®šä¹‰æºæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨ OneDriveã€ç™¾åº¦ç½‘ç›˜ã€iCloudã€Dropbox ç­‰è¿›è¡Œå¤šè®¾å¤‡åŒæ­¥</p>
<p>ğŸŒ± å½“ç„¶ <strong>Gridea</strong> è¿˜å¾ˆå¹´è½»ï¼Œæœ‰å¾ˆå¤šä¸è¶³ï¼Œä½†è¯·ç›¸ä¿¡ï¼Œå®ƒä¼šä¸åœå‘å‰ğŸƒ</p>
<p>æœªæ¥ï¼Œå®ƒä¸€å®šä¼šæˆä¸ºä½ ç¦»ä¸å¼€çš„ä¼™ä¼´</p>
<p>å°½æƒ…å‘æŒ¥ä½ çš„æ‰åå§ï¼</p>
<p>ğŸ˜˜ Enjoy~</p>
]]></content>
    </entry>
</feed>